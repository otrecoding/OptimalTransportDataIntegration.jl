<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Transport within a data source · OptimalTransportDataIntegration</title><meta name="title" content="Transport within a data source · OptimalTransportDataIntegration"/><meta property="og:title" content="Transport within a data source · OptimalTransportDataIntegration"/><meta property="twitter:title" content="Transport within a data source · OptimalTransportDataIntegration"/><meta name="description" content="Documentation for OptimalTransportDataIntegration."/><meta property="og:description" content="Documentation for OptimalTransportDataIntegration."/><meta property="twitter:description" content="Documentation for OptimalTransportDataIntegration."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">OptimalTransportDataIntegration</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Quickstart</a></li><li class="is-active"><a class="tocitem" href>Transport within a data source</a></li><li><a class="tocitem" href="../joint_ot_between_bases/">Transport between data sources</a></li><li><a class="tocitem" href="../learning/">Machine Learning</a></li><li><a class="tocitem" href="../simulations/">Numerical experiments</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Transport within a data source</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Transport within a data source</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/otrecoding/OptimalTransportDataIntegration.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/otrecoding/OptimalTransportDataIntegration.jl/blob/main/docs/src/joint_ot_within_base.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Optimal-transport-of-the-joint-distribution-within-a-data-source"><a class="docs-heading-anchor" href="#Optimal-transport-of-the-joint-distribution-within-a-data-source">Optimal transport of the joint distribution within a data source</a><a id="Optimal-transport-of-the-joint-distribution-within-a-data-source-1"></a><a class="docs-heading-anchor-permalink" href="#Optimal-transport-of-the-joint-distribution-within-a-data-source" title="Permalink"></a></h1><article><details class="docstring" open="true"><summary id="OptimalTransportDataIntegration.Instance"><a class="docstring-binding" href="#OptimalTransportDataIntegration.Instance"><code>OptimalTransportDataIntegration.Instance</code></a> — <span class="docstring-category">Type</span></summary><section><div><pre><code class="language-julia hljs">struct Instance</code></pre><p>Definition and initialization of an Instance structure</p><ul><li>datafile : file name</li><li>distance : ∈ ( Cityblock, Euclidean, Hamming )</li><li>indXA    : indexes of subjects of A with given X value</li><li>indXB    : indexes of subjects of B with given X value</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/otrecoding/OptimalTransportDataIntegration.jl/blob/972b019290e46df9e35cbe73eb02472dab094ed6/src/instance.jl#L6">source</a></section></details></article><article><details class="docstring" open="true"><summary id="OptimalTransportDataIntegration.joint_ot_within_base_continuous-Tuple{Any}"><a class="docstring-binding" href="#OptimalTransportDataIntegration.joint_ot_within_base_continuous-Tuple{Any}"><code>OptimalTransportDataIntegration.joint_ot_within_base_continuous</code></a> — <span class="docstring-category">Method</span></summary><section><div><pre><code class="language-julia hljs">joint_ot_within_base_continuous(
    data;
    lambda,
    alpha,
    percent_closest,
    distance,
    Ylevels,
    Zlevels
)
</code></pre><p>Balance within-base distributions via optimal transport for continuous covariates.</p><p>Specialized within-base method for continuous covariate data. Solves linear programming  problem to transport and reweight individuals within each base (A and B) independently, balancing covariate and outcome distributions. Does NOT match across bases—solves two  separate OT problems (one per base) to improve within-base alignment of outcomes to  marginal covariate distributions.</p><p><strong>Arguments</strong></p><ul><li><code>data::DataFrame</code>: Input data with columns <code>database</code> (1 for base A, 2 for base B),  <code>X*</code> continuous covariates, <code>Y</code> (outcome for base B), and <code>Z</code> (outcome for base A)</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>lambda::Float64</code>: Regularization weight for covariate smoothness; default: 0.392</li><li><code>alpha::Float64</code>: Outcome alignment weight; default: 0.714</li><li><code>percent_closest::Float64</code>: Fraction of closest neighbors for cost averaging; default: 0.2</li><li><code>distance::Distances.Metric</code>: Distance metric for covariate space; default: Euclidean()</li><li><code>Ylevels::AbstractRange</code>: Categorical levels for outcome Y; default: 1:4</li><li><code>Zlevels::AbstractRange</code>: Categorical levels for outcome Z; default: 1:3</li></ul><p><strong>Returns</strong></p><ul><li><code>Tuple{Vector{Int}, Vector{Int}}</code>: Predicted outcomes (YB, ZA)<ul><li><code>YB</code>: Balanced outcome predictions for base B</li><li><code>ZA</code>: Balanced outcome predictions for base A</li></ul></li></ul><p><strong>Algorithm</strong></p><ol><li>Digitize continuous covariates into categorical bins using quartiles</li><li>Compute median covariate values per bin for distance computation</li><li>Build distance matrix D between individuals (base A vs base B)</li><li>Aggregate individuals by covariate-outcome combinations</li><li>Compute cost matrix C[y,z] by averaging distances between:<ul><li>Y=y individuals and closest Z=z individuals</li><li>Z=z individuals and closest Y=y individuals</li></ul></li><li>Build linear program for each base (A, B) independently:<ul><li>Decision variables: joint probabilities γ[x,y,z] for (covariate, Y, Z)</li><li>Constraints: marginal consistency with observed distributions</li><li>Objective: minimize transportation cost with covariate and outcome regularization</li></ul></li><li>Solve LP using Clp solver</li><li>Extract and return predicted outcomes</li></ol><p><strong>Key Design Choices</strong></p><ul><li><strong>Within-base</strong>: Solves independent LP for base A and base B (no cross-base matching)</li><li><strong>Continuous specialization</strong>: Digitizes continuous covariates; uses median bin values</li><li><strong>Regularization</strong>: lambda controls smoothness of covariate reweighting</li><li><strong>Neighborhood-based cost</strong>: Averages distances to percent_closest neighbors (robust)</li><li><strong>Linear programming</strong>: Exact solution via Clp (not approximate like unbalanced OT)</li></ul><p><strong>Details</strong></p><ul><li><strong>Covariate binning</strong>: Uses quantiles [0.25, 0.5, 0.75] to create 4 bins</li><li><strong>Distance computation</strong>: Euclidean on median bin values within each base</li><li><strong>Cost matrix</strong>: Symmetric averaging (YZ + ZY) prevents asymmetric bias</li><li><strong>Marginal constraints</strong>: Maintains observed covariate and outcome distributions</li><li><strong>Outcome prediction</strong>: Extracted from optimal coupling as argmax probability</li></ul><p><strong>See Also</strong></p><ul><li><code>joint_ot_within_base_discrete</code>: Discrete covariate version with aggregation</li><li><code>JointOTWithinBase</code>: Main dispatcher for within-base methods</li><li><code>JointOTBetweenBases</code>: Between-bases matching (different approach)</li></ul><p><strong>Notes</strong></p><ul><li><strong>Reference implementation</strong>: Demonstrates balanced LP approach vs OT methods</li><li><strong>Within-base only</strong>: Does not integrate across bases (limited integration benefit)</li><li><strong>Continuous focus</strong>: Leverages continuous structure via median binning</li><li><strong>No cross-base info</strong>: Cannot use cross-base information for matching</li><li><strong>Moderate scalability</strong>: LP solver may be slower than OT for large n</li><li><strong>Exact solution</strong>: Linear program guarantees optimality (vs approximate methods)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/otrecoding/OptimalTransportDataIntegration.jl/blob/972b019290e46df9e35cbe73eb02472dab094ed6/src/joint_ot_within_base_continuous.jl#L3">source</a></section></details></article><article><details class="docstring" open="true"><summary id="OptimalTransportDataIntegration.ot_joint-Tuple{Instance, Float64, Float64, Float64}"><a class="docstring-binding" href="#OptimalTransportDataIntegration.ot_joint-Tuple{Instance, Float64, Float64, Float64}"><code>OptimalTransportDataIntegration.ot_joint</code></a> — <span class="docstring-category">Method</span></summary><section><div><pre><code class="language-julia hljs">ot_joint(
    inst,
    alpha,
    lambda,
    percent_closest;
    norme,
    aggregate_tol,
    verbose
)
</code></pre><p>Solve linear program for within-base outcome balancing via optimal transport.</p><p>Core solver for within-base OT matching on discrete covariates. Takes pre-computed Instance with distance matrices and individual aggregation, then formulates and solves linear programs (one per base A, B) to find joint distributions of (X, Y, Z) that balance covariate and  outcome distributions while minimizing transportation cost.</p><p><strong>Arguments</strong></p><ul><li><code>inst::Instance</code>: Pre-computed instance with distance matrices and aggregation indices</li><li><code>alpha::Float64</code>: Weight balancing covariate regularization (higher = prioritize covariates)</li><li><code>lambda::Float64</code>: Coefficient controlling overall regularization strength</li><li><code>percent_closest::Float64</code>: Fraction of closest neighbors for cost computation (robustness)</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>norme::Metric</code>: Distance metric for covariate neighbors; default: Euclidean()</li><li><code>aggregate_tol::Float64</code>: Tolerance for covariate aggregation (unused in main algorithm); default: 0.5</li><li><code>verbose::Bool</code>: Enable detailed logging of results; default: false</li></ul><p><strong>Returns</strong></p><ul><li><code>Solution</code>: Object containing optimal transport plan and outcome predictions</li></ul><p><strong>Algorithm Details</strong></p><ol><li>Pre-aggregate individuals by similar covariate values (using Instance)</li><li>Compute cost matrix C[y,z] from instance pre-computed distances</li><li>Build linear program per base with:<ul><li>Variables: γ[x,y,z] joint probabilities of (covariate, Y, Z)</li><li>Constraints: marginals match observed distributions</li><li>Objective: minimize transport cost + regularization</li></ul></li><li>Solve LP using Clp (simplex algorithm)</li><li>Extract solution and compute outcome predictions</li></ol><p><strong>Model Structure</strong></p><p>The LP formulates the problem:</p><pre><code class="language-julia hljs">min  ⟨C, γ⟩ + λ·(regularization on covariate matching)
s.t. marginal constraints ensuring statistical consistency
     γ ≥ 0 (probabilities non-negative)</code></pre><p><strong>Optimization Targets</strong></p><ul><li><strong>Covariate alignment</strong>: Regularization ensures covariate marginals stay close to observed</li><li><strong>Outcome prediction</strong>: Cost matrix drives outcome rebalancing via OT</li><li><strong>Stability</strong>: Neighborhood averaging and regularization prevent overfitting</li></ul><p><strong>See Also</strong></p><ul><li><code>Instance</code>: Pre-computation structure</li><li><code>average_distance_to_closest</code>: Cost matrix computation</li><li><code>Solution</code>: Output structure</li></ul><p><strong>Notes</strong></p><ul><li>Requires pre-computed Instance for efficiency</li><li>Two independent LP solves (base A and base B)</li><li>Uses Clp solver for exactness (not approximate)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/otrecoding/OptimalTransportDataIntegration.jl/blob/972b019290e46df9e35cbe73eb02472dab094ed6/src/joint_ot_within_base_discrete.jl#L3">source</a></section></details></article><article><details class="docstring" open="true"><summary id="OptimalTransportDataIntegration.average_distance_to_closest-Tuple{Instance, Float64}"><a class="docstring-binding" href="#OptimalTransportDataIntegration.average_distance_to_closest-Tuple{Instance, Float64}"><code>OptimalTransportDataIntegration.average_distance_to_closest</code></a> — <span class="docstring-category">Method</span></summary><section><div><pre><code class="language-julia hljs">average_distance_to_closest(inst, percent_closest)
</code></pre><p>Compute the cost between pairs of outcomes as the average distance between covariations of individuals with these outcomes, but considering only the percent closest neighbors</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/otrecoding/OptimalTransportDataIntegration.jl/blob/972b019290e46df9e35cbe73eb02472dab094ed6/src/average_distance_closest.jl#L1">source</a></section></details></article><article><details class="docstring" open="true"><summary id="OptimalTransportDataIntegration.Solution"><a class="docstring-binding" href="#OptimalTransportDataIntegration.Solution"><code>OptimalTransportDataIntegration.Solution</code></a> — <span class="docstring-category">Type</span></summary><section><div><pre><code class="language-julia hljs">mutable struct Solution</code></pre><ul><li>tsolve       : solution time</li><li>jointYZA     : joint distribution of Y and Z in A</li><li>jointYZB     : joint distribution of Y and Z in B</li><li>estimatorZA  : estimator of probability of Z for individuals in base A</li><li>estimatorYB  : estimator of probability of Y for individuals in base B</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/otrecoding/OptimalTransportDataIntegration.jl/blob/972b019290e46df9e35cbe73eb02472dab094ed6/src/solution.jl#L3">source</a></section></details></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Quickstart</a><a class="docs-footer-nextpage" href="../joint_ot_between_bases/">Transport between data sources »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Thursday 8 January 2026 14:30">Thursday 8 January 2026</span>. Using Julia version 1.12.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
